<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>口罩地圖</title>
    <!-- <link rel="stylesheet" href="css/bootstrap.min.css"> -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB" crossorigin="anonymous">
    <link rel="stylesheet" href="css/color-chatgpt1.css">
    <link rel="stylesheet" href="css/mycss.css">
    <link rel="stylesheet" href="css/table-rwd.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <link rel="stylesheet" href="css/MarkerCluster.css">

    <style>
        .list-group {
            height: 85vh;
            overflow: scroll;
            /*螢幕滾動*/
        }
    </style>
</head>

<body>
    <div class="container-fluid">
        <div class="row vh-100">
            <div class="col-md-4 bgy-1">
                <select name="" id="cityOption" class="form-select form-select-lg mt-3">
                    <option value="" selected disabled class="fw-900">---請選擇縣市名稱---</option>
                    <option value="台北市">台北市</option>
                    <option value="台中市">台中市</option>
                </select>
                <select name="" id="areaOption" class="form-select form-select-lg mt-3" disabled>
                    <option value="" selected disabled class="fw-900">---請選擇鄉鎮市名稱---</option>
                    <option value="西屯區">西屯區</option>
                    <option value="南屯區">南屯區</option>
                </select>
                <ul class="list-group mt-3">
                    <li class="list-group-item">
                        <div class="h4 fw-900">藥局名稱</div>
                        <div class="h4 fw-900">地址</div>
                        <div class="h4 fw-900 mb-0">電話</div>
                        <div class="h4 fw-900 mb-0">成人口罩<span class="fw-900 h1 text-danger">99</span>個</div>
                        <div class="h4 fw-900 mb-0">兒童口罩<span class="fw-900 h1 text-danger">99</span>個</div>
                    </li>
                </ul>
            </div>
            <div class="col-md-8 bgb-1 p-0">
                <div id="map" class="w-100 h-100"></div>
            </div>
        </div>

    </div>

    <script src="js/axios.min.js"></script>
    <!-- <script src="js/bootstrap.bundle.min.js"></script> -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-FKyoEForCGlyvwx9Hj09JcYn3nv7wiPVlz7YYwJrWVcXK/BmnVDxM+D2scQbITxI"
        crossorigin="anonymous"></script>
    <script src="js/jquery-3.7.1.js"></script>
    <script src="js/sweetalert2@11.js"></script>
    <script src="js/wow.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script src="js/leaflet.markercluster.js"></script>

    <script>
        let cityData; //儲存縣市資料
        let selectedCity; //儲存已經選擇的縣市選單
        let selectedArea; //儲存鄉鎮市區名稱
        let maskData; //儲存口罩藥局資料
        let map; //儲存地圖
        let markerClaster; //

        $(async function () {
            //載入地圖
            initMap();

            //取得縣市資料
            cityData = await getCityData();
            console.log(cityData);

            //取得口罩藥局資料
            maskData = await getMaskData();
            console.log(maskData);

            //產生選單
            renderCityOption(cityData);

            //監聽縣市選單
            $("#cityOption").on("change", function () {
                console.log($(this).val());
                selectedCity = $(this).val();

                //打開鄉鎮市區選單
                $("#areaOption").prop("disabled", false)

                cityData.forEach((item) => {
                    if (item.CityName == selectedCity) {
                        //產生該縣市選單
                        renderAreaOption(item.AreaList)
                    }
                });
            });

            //監聽鄉鎮市區選單
            $("#areaOption").on("change", function () {
                console.log($(this).val());
                selectedArea = $(this).val();

                //過濾口罩藥局資料
                let filterData = maskData.features.filter(item => {
                    return item.properties.county == selectedCity && item.properties.town == selectedArea
                });

                //產生藥局列表
                renderMaskList(filterData);

                //清除所有markers
                removeMarkers();

                //產生markers
                renderMarkers(filterData);

            });

            //監聽mask-item 口罩藥局列表
            $(document).on("click", ".mask-item", function(){
                const key = $(this).data("key");
                const marker = markerMap[key];
                // map.panTo(marker.getLatLng());
                // marker.openPopup();
                markersCluster
            });
        });

        //產生地圖
        function initMap() {
            map = L.map('map').setView([24.171425, 120.609670], 13);

            L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);

            L.marker([24.171425, 120.609670]).addTo(map)
                .bindPopup('中分署')
                .openPopup();

        }

        //取得縣市資料
        function getCityData() {
            return $.ajax({
                type: "GET",
                url: "js/json/CityCountyData.json",
                dataType: "json"
            });
        }

        //取得口罩藥局資料
        function getMaskData() {
            return $.ajax({
                type: "GET",
                url: "js/json/points.json",
                dataType: "json"
            });
        }

        //產生縣市選單
        function renderCityOption(data) {
            $("#cityOption").empty();
            $("#cityOption").append(`<option value="" selected disabled class="fw-900">---請選擇縣市名稱---</option>`);
            data.forEach((item) => {
                let strHMTL = `<option value="${item.CityName}">${item.CityName}</option>`;
                $("#cityOption").append(strHMTL);
            });
        }

        //產生鄉鎮市區選單
        function renderAreaOption(data) {
            $("#areaOption").empty();
            $("#areaOption").append(`<option value="" selected disabled class="fw-900">---請選擇鄉鎮市區名稱---</option>`);
            data.forEach((item) => {
                let strHMTL = `<option value="${item.AreaName}">${item.AreaName}</option>`;
                $("#areaOption").append(strHMTL);
            });
        }

        //產生口罩藥局列表
        function renderMaskList(data) {
            $(".list-group").empty();

            //沒有口罩藥局資料的地區
            if (data.length == 0) {
                $(".list-group").append(`
                    <li class="list-group-item">
                        <div class="h4 fw-900 text-muted">該地區沒有配售的藥局或是沒有相關資料</div>
                    </li>`);
                return;
            }

            //有資料才渲染
            data.forEach((item, key) => {
                let strHTML = `<li class="list-group-item mask-item" data-key="${key}">
                        <div class="h4 fw-900">${item.properties.name}</div>
                        <div class="h4 fw-900">${item.properties.address}</div>
                        <div class="h4 fw-900 mb-0">${item.properties.phone}</div>
                        <div class="h4 fw-900 mb-0">成人口罩<span class="fw-900 h1 text-danger">${item.properties.mask_adult}</span>個</div>
                        <div class="h4 fw-900 mb-0">兒童口罩<span class="fw-900 h1 text-danger">${item.properties.mask_child}</span>個</div>
                    </li>`;
                $(".list-group").append(strHTML);
            });

        }

        //產生marker列表
        function renderMarkers(data) {
            //如果沒有資料
            if (data.length == 0) {
                return;
            }

            //產生索引表給list-item呼叫
            markerMap = {};

            data.forEach((item, key) => {
                const lat = item.geometry.coordinates[1];
                const lng = item.geometry.coordinates[0];
                if (key == 0) {
                    map.panTo([lat, lng]);
                }
                let popupHTML = `<div class="card">
                <div class="card-body">
                    <div class="h5 fw-500">${item.properties.name}</div>
                        <div class="h5 fw-500">${item.properties.address}</div>
                        <div class="h5 fw-500 mb-0">${item.properties.phone}</div>
                        <div class="h5 fw-500 mb-0">成人口罩<span class="fw-900 h1 text-danger">${item.properties.mask_adult}</span>個</div>
                        <div class="h5 fw-500 mb-0">兒童口罩<span class="fw-900 h1 text-danger">${item.properties.mask_child}</span>個</div>
                    </div>
                    </div>`
                const marker = L.marker([lat, lng]).addTo(map)
                    .bindPopup(popupHTML)
                    .openPopup();

                //產生索引給list-item呼叫
                markerMap[key] = marker;

            });

        }

        //清除所有markers
        function removeMarkers(data) {
            // map.eachLayer(function (layer) {
            //     if (layer instanceof L.Marker) {
            //         map.removeLayer(layer)
            //     }
            // });
            markersCluster.clearLayers();
            markerMap = {};
        }

    </script>


</body>

</html>